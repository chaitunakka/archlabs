function JPEGEncoder(e){function a(e){for(var a=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],r=0;r<64;r++){var n=S((a[r]*e+50)/100);n<1?n=1:n>255&&(n=255),C[D[r]]=n}for(var o=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],t=0;t<64;t++){var c=S((o[t]*e+50)/100);c<1?c=1:c>255&&(c=255),M[D[t]]=c}for(var d=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],f=0,i=0;i<8;i++)for(var v=0;v<8;v++)E[f]=1/(C[D[f]]*d[i]*d[v]*8),_[f]=1/(M[D[f]]*d[i]*d[v]*8),f++;B[e]=[C.slice(),M.slice(),E.slice(),_.slice()]}function r(e,a){for(var r=0,n=0,o=new Array,t=1;t<=16;t++){for(var c=1;c<=e[t];c++)o[a[n]]=[],o[a[n]][0]=r,o[a[n]][1]=t,n++,r++;r*=2}return o}function n(){w=r(F,H),l=r(R,T),m=r(K,L),I=r(U,V)}function o(){for(var e=1,a=2,r=1;r<=15;r++){for(var n=e;n<a;n++)j[32767+n]=r,J[32767+n]=[],J[32767+n][1]=r,J[32767+n][0]=n;for(var o=-(a-1);o<=-e;o++)j[32767+o]=r,J[32767+o]=[],J[32767+o][1]=r,J[32767+o][0]=a-1+o;e<<=1,a<<=1}}function t(e){for(var a=e[0],r=e[1]-1;r>=0;)a&1<<r&&(k|=1<<O),r--,--O<0&&(255==k?(c(255),c(0)):c(k),O=7,k=0)}function c(e){b.push(z[e])}function d(e){c(e>>8&255),c(255&e)}function f(e,a){var r,n,o,t,c,d,f,i,v,h=0;for(v=0;v<8;++v){r=e[h],n=e[h+1],o=e[h+2],t=e[h+3],c=e[h+4],d=e[h+5],f=e[h+6];var s=r+(i=e[h+7]),u=r-i,x=n+f,g=n-f,y=o+d,p=o-d,w=t+c,l=t-c,m=s+w,I=s-w,A=x+y,S=x-y;e[h]=m+A,e[h+4]=m-A;var C=.707106781*(S+I);e[h+2]=I+C,e[h+6]=I-C;var M=.382683433*((m=l+p)-(S=g+u)),E=.5411961*m+M,_=1.306562965*S+M,J=.707106781*(A=p+g),j=u+J,b=u-J;e[h+5]=b+E,e[h+3]=b-E,e[h+1]=j+_,e[h+7]=j-_,h+=8}for(h=0,v=0;v<8;++v){r=e[h],n=e[h+8],o=e[h+16],t=e[h+24],c=e[h+32],d=e[h+40],f=e[h+48];var k=r+(i=e[h+56]),O=r-i,Q=n+f,q=n-f,G=o+d,P=o-d,z=t+c,B=t-c,D=k+z,F=k-z,H=Q+G,K=Q-G;e[h]=D+H,e[h+32]=D-H;var L=.707106781*(K+F);e[h+16]=F+L,e[h+48]=F-L;var R=.382683433*((D=B+P)-(K=q+O)),T=.5411961*D+R,U=1.306562965*K+R,V=.707106781*(H=P+q),W=O+V,X=O-V;e[h+40]=X+T,e[h+24]=X-T,e[h+8]=W+U,e[h+56]=W-U,h++}var Y;for(v=0;v<64;++v)Y=e[v]*a[v],N[v]=Y>0?Y+.5|0:Y-.5|0;return N}function i(){d(65504),d(16),c(74),c(70),c(73),c(70),c(0),c(1),c(1),c(0),d(1),d(1),c(0),c(0)}function v(e,a){d(65472),d(17),c(8),d(a),d(e),c(3),c(1),c(17),c(0),c(2),c(17),c(1),c(3),c(17),c(1)}function h(){d(65499),d(132),c(0);for(var e=0;e<64;e++)c(C[e]);c(1);for(var a=0;a<64;a++)c(M[a])}function s(){d(65476),d(418),c(0);for(var e=0;e<16;e++)c(F[e+1]);for(var a=0;a<=11;a++)c(H[a]);c(16);for(var r=0;r<16;r++)c(K[r+1]);for(var n=0;n<=161;n++)c(L[n]);c(1);for(var o=0;o<16;o++)c(R[o+1]);for(var t=0;t<=11;t++)c(T[t]);c(17);for(var f=0;f<16;f++)c(U[f+1]);for(var i=0;i<=161;i++)c(V[i])}function u(){d(65498),d(12),c(3),c(1),c(0),c(2),c(17),c(3),c(17),c(0),c(63),c(0)}function x(e,a,r,n,o){for(var c,d=o[0],i=o[240],v=f(e,a),h=0;h<64;++h)Q[D[h]]=v[h];var s=Q[0]-r;r=Q[0],0==s?t(n[0]):(t(n[j[c=32767+s]]),t(J[c]));for(var u=63;u>0&&0==Q[u];u--);if(0==u)return t(d),r;for(var x,g=1;g<=u;){for(var y=g;0==Q[g]&&g<=u;++g);var p=g-y;if(p>=16){x=p>>4;for(var w=1;w<=x;++w)t(i);p&=15}c=32767+Q[g],t(o[(p<<4)+j[c]]),t(J[c]),g++}return 63!=u&&t(d),r}function g(){for(var e=String.fromCharCode,a=0;a<256;a++)z[a]=e(a)}function y(e,a){b=new Array,k=0,O=7,d(65496),i(),h(),v(e,a),s(),u()}function p(){for(var e=0;e<256;e++)W[e]=19595*e,W[e+256>>0]=38470*e,W[e+512>>0]=7471*e+32768,W[e+768>>0]=-11059*e,W[e+1024>>0]=-21709*e,W[e+1280>>0]=32768*e+8421375,W[e+1536>>0]=-27439*e,W[e+1792>>0]=-5329*e}var w,l,m,I,A=this,S=(Math.round,Math.floor),C=new Array(64),M=new Array(64),E=new Array(64),_=new Array(64),J=new Array(65535),j=new Array(65535),N=new Array(64),b=[],k=0,O=7,Q=new Array(64),q=new Array(64),G=new Array(64),P=new Array(64),z=new Array(256),B=[],D=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],F=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],H=[0,1,2,3,4,5,6,7,8,9,10,11],K=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],L=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],R=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],T=[0,1,2,3,4,5,6,7,8,9,10,11],U=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],V=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];this.encode=function(e,a){this.encode.displayName="_encode_",a&&A.setQuality(a),y(e.width,e.height);var r=0,n=0,o=0;k=0,O=7;for(var c,f,i,v,h,s,u,g,p,S=e.data,C=e.width,M=e.height,J=3*C,j=0;j<M;){for(c=0;c<J;){for(s=h=J*j+c,u=-1,g=0,p=0;p<64;p++)s=h+(g=p>>3)*J+(u=3*(7&p)),j+g>=M&&(s-=J*(j+1+g-M)),c+u>=J&&(s-=c+u-J+3),f=S[s++],i=S[s++],v=S[s++],q[p]=(W[f]+W[i+256>>0]+W[v+512>>0]>>16)-128,G[p]=(W[f+768>>0]+W[i+1024>>0]+W[v+1280>>0]>>16)-128,P[p]=(W[f+1280>>0]+W[i+1536>>0]+W[v+1792>>0]>>16)-128;r=x(q,E,r,w,m),n=x(G,_,n,l,I),o=x(P,_,o,l,I),c+=24}j+=8}if(O>=0){var N=[];N[1]=O+1,N[0]=(1<<O+1)-1,t(N)}d(65497),postMessage(b.join(""))};var W=new Array(2048);this.setQuality=function(e){e||(e=50),e<=0&&(e=1),e>100&&(e=100);var r=0;r=e<50?Math.floor(5e3/e):Math.floor(200-2*e),B[r]?(C=B[r][0],M=B[r][1],E=B[r][2],_=B[r][3]):a(r)},this.clearCaches=function(){B=[]},g(),n(),o(),p(),A.setQuality(e)}function clearCaches(){imageCache=[],metaStorage=[],encoder.clearCaches()}function prepareImage(e,a,r){for(var n=e.length,o=new Array(n),t=0;t<n;t++)o[t]=e.charCodeAt(t);return{data:o,width:a,height:r}}var encoder=new JPEGEncoder,imageCache=[],metaStorage=[],expectMode="json",expectedIndex=0,doEncode=!0;onmessage=function(e){if("json"==expectMode){var a=JSON.parse(e.data);switch(a.command){case"encode_new":doEncode=!0,expectMode="imgString",metaStorage[a.data.cacheIndex]=a.data,expectedIndex=a.data.cacheIndex;break;case"cache_only":doEncode=!1,expectMode="imgString",metaStorage[a.data.cacheIndex]=a.data,expectedIndex=a.data.cacheIndex;break;case"encode_cached":doEncode=!0,postMessage(JSON.stringify({cacheIndex:a.data.cacheIndex})),encoder.encode(imageCache[a.data.cacheIndex],a.data.quality);break;case"clear_caches":clearCaches()}}else imageCache[expectedIndex]=prepareImage(e.data,metaStorage[expectedIndex].width,metaStorage[expectedIndex].height),doEncode&&(postMessage(JSON.stringify({cacheIndex:expectedIndex})),encoder.encode(imageCache[expectedIndex],metaStorage[expectedIndex].quality)),expectMode="json"};