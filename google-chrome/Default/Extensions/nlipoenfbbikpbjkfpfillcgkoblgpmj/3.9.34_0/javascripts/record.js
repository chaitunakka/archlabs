function resetData(){dataArray=new ArrayBuffer(0),audioArray=new ArrayBuffer(0)}function getPremium(){return new Promise(function(e,r){chrome.cookies.get({url:"https://www.awesomescreenshot.com",name:"screenshot_personal_type"},function(r){e(r&&"1"==r.value?!0:!1)})})}function refreshCookie(){$.get(baseUrl+"/promotion_ex")}function goToUpgrade(){var e="https://www.awesomescreenshot.com";chrome.cookies.get({url:e,name:"screenshot_personal_type"},function(r){if(r){if("0"==r.value)t="/premium/upgrade"}else var t="/user/login?type=record_screen";chrome.tabs.create({url:e+t})})}function getMic(e,r){window.navigator.webkitGetUserMedia({audio:{optional:[{echoCancellation:!1}]}},function(r){e(r)},function(e){})}function getStream(e){return new Promise(function(r,t){if("tab"==e)chrome.tabCapture.capture({video:!0,videoConstraints:{mandatory:{maxWidth:2560,maxHeight:1440}}},function(e){r(e)});else if("desktop"==e){var o=["screen","window"];"Mac OS"==getOS()&&o.push("audio"),chrome.desktopCapture.chooseDesktopMedia(o,function(e){if(e){var o={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e},optional:[]},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:2560,maxHeight:1440}}};window.navigator.webkitGetUserMedia(o,r,t)}})}})}function setBadge(e,r){"text"===e?chrome.browserAction.setBadgeText({text:r}):"color"===e&&chrome.browserAction.setBadgeBackgroundColor({color:r})}function beginRecord(e){e.isRecordMic&&getMic(function(e){audioStream=e}),getStream(e.recordType).then(function(r){if(setBadge("color","red"),e.countdown>0)var t=parseInt(e.countdown),o=setInterval(function(){setBadge("text",t+""),0==t&&(clearInterval(o),setBadge("text","REC"),gotStream(r)),t--},1e3);else gotStream(r)}).catch(function(e){console.log("[ERROE]: ",e)})}function captureTabUsingTabCapture(e){getMic(function(e){audioStream=e});screen.width,screen.height;chrome.desktopCapture.chooseDesktopMedia(["screen","window","audio"],function(e){if(e){var r={audio:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e},optional:[]},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxWidth:2560,maxHeight:1440}}};window.navigator.webkitGetUserMedia(r,function(e){gotStream(e)},function(){})}})}function canvasRecord(e){function r(){console.log("sdfsd"),n.drawImage(t,0,0,t.clientWidth,t.clientHeight),window.recorder&&recorder.stopped||requestAnimationFrame(r)}var t=document.getElementById("desktop-video");t.src=URL.createObjectURL(e),t.play();var o=document.getElementById("tempCanvas"),n=o.getContext("2d");recorder=RecordRTC(o,{type:"canvas"}),console.log(recorder),e.onended=function(){recorder&&(e.onended=function(){}),document.getElementById("awesome").postMessage({command:"stop"}),audioStream&&audioStream.stop(),recorder.stopped=!0,recorder.stopRecording(function(){var e=recorder.getBlob();console.log(e)})},e.getVideoTracks()[0].onended=function(){recorder&&e.onended()},console.log("sdf"),r(),recorder.startRecording()}function handleMessage(e){console.log("[NACL]: ",e.data.name,e.data.message),"videodata"==e.data.name?appendVideoData(e.data.data):"videoend"==e.data.name&&fileSaver.save(new Blob([dataArray],{type:"video/webm"}),"AwesomeScreenshot-"+(new Date).toISOString().replace(/:|\./g,"-")+".webm").then(function(e){chrome.runtime.sendMessage({name:"stop"},function(){chrome.tabs.create({url:"/video.html?srcUrl="+e+"&name=record.webm"})})}).catch(function(e){console.log(e)})}function appendVideoData(e){var r=new Uint8Array(dataArray.byteLength+e.byteLength);r.set(new Uint8Array(dataArray),0),r.set(new Uint8Array(e),dataArray.byteLength),dataArray=r.buffer,console.log("video: "+e.byteLength)}function gotStream2(e){resetData(),track=e.getVideoTracks()[0];var r=$("video")[0];if(r.src=URL.createObjectURL(e),r.muted=!0,r.play(),console.log(r),audioStream)var t=(o=audioStream.getAudioTracks()[0]).getConstraints();else{var o=null;t={}}var n=$("profileList"),a=n.length<1?"vp8":n.options[n.selectedIndex].value,i={};console.log({command:"start",track:track,profile:a,filename:file_name,channelCount:t.channelCount?t.channelCount:2,audioSampleRate:t.sampleRate?t.sampleRate:48e3,sampleSize:t.sampleSize?t.sampleSize:16,frameRate:i.frameRate?i.frameRate:25,width:i.width?i.width:2560,height:i.height?i.height:1440}),document.getElementById("awesome").postMessage({command:"start",track:track,profile:a,filename:file_name,width:i.width?i.width:screen.width,height:i.height?i.height:screen.height}),startDate=new Date,intervalID=setInterval(function(){var e=new Date-startDate;$("length").innerHTML="Time interval: "+e},100),e.getVideoTracks()[0].onended=function(){document.getElementById("awesome").postMessage({command:"stop"})}}function gotStream(e){var r={type:"video",disableLogs:!1,recorderType:MediaStreamRecorder};if(r.mimeType="video/webm; codecs="+"vp8".toLowerCase(),audioStream&&audioStream.getAudioTracks&&audioStream.getAudioTracks().length){audioPlayer=document.createElement("audio"),audioPlayer.src=URL.createObjectURL(audioStream),audioPlayer.muted=!0,audioPlayer.play(),context=new AudioContext;var t=context.createGain();t.connect(context.destination),t.gain.value=0,mediaStremSource=context.createMediaStreamSource(audioStream),mediaStremSource.connect(t),mediaStremDestination=context.createMediaStreamDestination(),mediaStremSource.connect(mediaStremDestination),e.addTrack(mediaStremDestination.stream.getAudioTracks()[0])}recorder=RecordRTC(e,r);try{recorder.startRecording(),alreadyHadGUMError=!1}catch(e){getUserMediaError()}recorder.stream=e,isRecording=!0,recorder.stream.onended=function(){recorder&&recorder.stream&&(recorder.stream.onended=function(){}),audioStream&&audioStream.stop(),cameraStream&&cameraStream.stop(),stopScreenRecording()},recorder.stream.getVideoTracks()[0].onended=function(){recorder&&recorder.stream&&recorder.stream.onended&&recorder.stream.onended()},recordingStartTime=(new Date).getTime(),recordingTimer=setInterval(updateRecordingTime,100)}function checkTimeLength(e){e>=31e3&&getPremium().then(function(e){e||stopStream()})}function updateRecordingTime(){if(!isRecordingPaused){var e=(new Date).getTime()-recordingStartTime;pausedTime&&(e-=pausedTime),checkTimeLength(e),setBadge("text",recordingTime=secondsToTime(e))}}function secondsToTime(e){e=Math.floor(e/1e3);var r=Math.floor(e/3600),t=Math.floor((e-3600*r)/60),o=e%60;return o<10&&(o="0"+o),(r>0?r+":":"")+t+":"+o}function setDefaults(){recorder&&recorder.stream&&(recorder.stream.stop(),recorder&&recorder.stream&&recorder.stream.onended&&recorder.stream.onended()),recorder=null,isRecording=!1,recordingStartTime=null,recordingTime=null,imgIndex=0}function pauseScreenRecording(){recorder.pauseRecording(),isRecordingPaused=!0,lastPausingTime=(new Date).getTime()}function resumeScreenRecording(){recorder.resumeRecording(),isRecordingPaused=!1,pausedTime=pausedTime+(new Date).getTime()-lastPausingTime}function stopStream(){isRecordingPaused&&resumeScreenRecording(),recorder&&recorder.stream&&recorder.stream.onended()}function restoreRecording(){isRecording=!1,clearInterval(recordingTimer),recordingTimer=null,lastPausingTime=null,pausedTime=null,setBadge("text","")}function stopScreenRecording(){restoreRecording(),recorder.stopRecording(function(){saveVideo(),googleEvent("record video","record video");try{peer.close(),peer=null}catch(e){}try{audioPlayer.src=null,mediaStremDestination.disconnect(),mediaStremSource.disconnect(),context.disconnect(),context=null}catch(e){}}),timer&&clearTimeout(timer)}function getFileSize(e){var r=(e/1024).toFixed(2);return r=r<1024?r.toString().replace(",",".").replace(/\d{1,3}(?=(\d{3})+(?!\d))/g,"$&,")+" KB":(r=(r/1024).toFixed(2)).toString().replace(",",".").replace(/\d{1,3}(?=(\d{3})+(?!\d))/g,"$&,")+" MB"}function saveVideo(){var e="AwesomeScreenshot-"+(new Date).toISOString().replace(/:|\./g,"-"),r=(new File([recorder.getBlob()],e+".webm",{type:"video/webm"}),recorder.getBlob()),t=bytesToSize(r.size);fileSaver.save(r,e+".webm").then(function(r){DB.save({fileUrl:r,title:e,size:t,duration:recordingTime}).then(function(e){chrome.runtime.sendMessage({name:"stop"},function(){chrome.tabs.create({url:"/video.html?id="+e})}),setDefaults()})})}function googleEvent(e,r){ga&&ga("send","event","chrome extension",e,r)}function getOS(){window.navigator.userAgent;var e=window.navigator.platform,r=["Win32","Win64","Windows","WinCE"],t=null;return-1!==["Macintosh","MacIntel","MacPPC","Mac68K"].indexOf(e)?t="Mac OS":-1!==r.indexOf(e)?t="Windows":!t&&/Linux/.test(e)&&(t="Linux"),t}var getMicFrame=null,audioStream=null,cameraStream=null,tempVideo=null,MIME_TYPE="video/webm",file_name="/awesome/record.webm",isRecording=!1,isRecordingPaused=!1,recordingTime=0,recordingTimer=null,lastPausingTime=null,pausedTime=null,isPremium=!1,recordingStartTime=null,baseUrl="https://www.awesomescreenshot.com";chrome.cookies.get({url:baseUrl,name:"screenshot_personal_type"},function(e){void 0===e&&refreshCookie()}),$(document).ready(function(){}),DB.init(),window.addEventListener("message",function(e){"audioStream"==e.data.type&&(audioStream=e.data.steam)},!1),chrome.commands.onCommand.addListener(function(e){console.log("Command:",e),"stop-recording"===e?stopStream():"pause-or-resume-recording"===e&&(isRecordingPaused?resumeScreenRecording():pauseScreenRecording())});