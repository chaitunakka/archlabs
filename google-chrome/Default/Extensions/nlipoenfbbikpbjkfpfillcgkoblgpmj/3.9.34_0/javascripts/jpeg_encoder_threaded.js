function JPEGEncoderThreaded(e){function a(e,a,n,c,o){var s=new t(d,r,a,n,c);h[r]=s,r++;var u=o?"cache_only":"encode_new";i.postMessage(JSON.stringify({command:u,data:{cacheIndex:s._cachedImageIndex,quality:s.quality,cache:s._cache,width:e.width,height:e.height}}));for(var l=e.data,m=l.length,f=new Array(m/4*3),w=0,I=0;I<m;I+=4)f[w++]=g[l[I]],f[w++]=g[l[I+1]],f[w++]=g[l[I+2]];var _=f.join("");return f=null,i.postMessage(_),_=null,!c||s}function t(e,a,t,n,c){var e=e;this._cachedImageIndex=a,this._cache=c,this.quality=t,this.callback=n,this.encode=function(a){a&&(this.quality=a),e._encodeCached(this._cachedImageIndex,this.quality,this.callback)}}var n,c=e||"jpeg_encoder_threaded_worker.js",i=new Worker(c),r=0,h=[],d=this,o="json",s=0,g=function(){for(var e=String.fromCharCode,a=new Array(256),t=0;t<256;t++)a[t]=e(t);return a}();i.onmessage=function(e){var a;if("json"==o)a=JSON.parse(e.data),s=a.cacheIndex,o="datauri";else{a=h[s];var t=(new Date).getTime()-n;console.log("Threaded encoding time: "+t+"ms"),a.callback("data:image/jpeg;base64,"+btoa(e.data)),a._cache||(h[s]=null),o="json"}},this.encode=function(e,t,c,i){return n=(new Date).getTime(),a(e,t,c,i,!1)},this.prepareImage=function(e,t,n){return a(e,t,n,!0,!0)},this._encodeCached=function(e,a,t){n=(new Date).getTime(),i.postMessage(JSON.stringify({command:"encode_cached",data:{cacheIndex:e,quality:a}}))},this.clearCaches=function(){r=0,h=[],i.postMessage(JSON.stringify({command:"clear_caches"}))}}function getImageDataFromImage(e){var a="string"==typeof e?document.getElementById(e):e,t=document.createElement("canvas");t.width=a.width,t.height=a.height;var n=t.getContext("2d");return n.drawImage(a,0,0),n.getImageData(0,0,t.width,t.height)}