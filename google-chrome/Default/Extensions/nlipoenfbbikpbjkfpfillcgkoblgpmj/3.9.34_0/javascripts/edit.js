function toggleCropMode(e){e?($(".tools").hide(),$(".crop-area").show(),$("#save-btn").hide()):($(".tools").show(),$(".crop-area").hide(),$("#save-btn").show())}function editor_style_callback(e,t){switch(e){case"crop":"done"!==t&&($("#crop-dimension").show(),$("#cd-width").val(t.width),$("#cd-height").val(t.height));break;case"undo":$('.single-btn[data-action="undo"]').toggleClass("disabled",!t);break;case"redo":$('.single-btn[data-action="redo"]').toggleClass("disabled",!t);break;case"del":$('.single-btn[data-action="deleteSelected"]').toggleClass("disabled",!t);break;case"clear":$('.single-btn[data-action="clear"]').toggleClass("disabled",t)}}function initEditor(e){function t(){for(var e=0;e<imageArr.length;e++){var t=$('<div class="image-item"><img src="./images/svg/'+imageArr[e]+'.svg" alt=""></div>').data("data-image",u[e]);t.on("click",function(){editor.insertSvgImage($(this).data("data-image"))}),$(".tool-image-picker").find(".panel .panel-container").append(t)}}var a=$("#editor-outer-container"),o=a.find(".editor-container"),i=a.find(".doodle-canvas"),n=a.find(".layer-canvas"),s=a.find(".editor-outer-textarea"),r=a.find(".editor-textarea"),c=a.find(".editor-list-dialog"),l=new Image;editor=new Diigo.Doodle._Drawer({out_container:a[0],container:o[0],doodle_canvas:i[0],layer_canvas:n[0],textarea:r[0],textarea_out:s[0],$list_dialog:c,image:l},function(e,t){editor_style_callback(e,t)}),l.src=e,l.onload=function(){editor.setBgImage(l,!1),editor.setPenColor("#f00"),editor.setPenType("curve")},$(document).on("click",function(){$(".panel").removeClass("active"),$(".multi-btn-dropdown").removeClass("active"),$(".zoom-tip").removeClass("active")}),$("#insert-image-input").on("change",function(){var e=$(this),t=this.files[0];console.log("file:",t);var a=URL.createObjectURL(t),o=new Image;o.src=a;var i={image:o,width:0,height:0,choose_type:"full"};o.img_info=i,o.onload=function(){i.width=this.naturalWidth,i.height=this.naturalHeight,editor.insertSvgImage(i),e.val("")}}),$("#crop-dimension").find("input").on("change input",function(){var e=Number($("#cd-width").val()),t=Number($("#cd-height").val());editor.setCropSize(e,t)}),$(".single-btn").on("click",function(e){if(e.stopPropagation(),$(this).hasClass("shape-btn")){$(".shape-btn").removeClass("active"),$(this).toggleClass("active");var t=$(this).attr("data-shape");"Text"===t?($(".tool-font-family").css("display","inline-block"),$(".tool-font-size").css("display","inline-block"),$(".tool-reset-sequence").hide(),$(".tool-pen-width").hide(),editor.setPenType(t)):"callout"==t?chrome.cookies.get({url:"https://www.awesomescreenshot.com",name:"screenshot_personal_type"},function(a){return a?"1"!=a.value?(e.preventDefault(),void showPremium("w-aws-advanced","callout")):void editor.setPenType(t):(e.preventDefault(),void showPremium("w-aws-advanced-login","callout"))}):"list"==t?chrome.cookies.get({url:"https://www.awesomescreenshot.com",name:"screenshot_personal_type"},function(a){return a?"1"!=a.value?(e.preventDefault(),void showPremium("w-aws-advanced","step")):(editor.setPenType(t),$(".tool-reset-sequence").css("display","inline-block"),$(".tool-font-family").hide(),$(".tool-font-size").hide(),void $(".tool-pen-width").hide()):(e.preventDefault(),void showPremium("w-aws-advanced-login","step"))}):($(".tool-font-family").hide(),$(".tool-font-size").hide(),$(".tool-reset-sequence").hide(),$(".tool-pen-width").css("display","inline-block"),"highlight"===t?(editor.setPenOpacity(.3),editor.setPenWidth(16)):(editor.setPenOpacity(1),editor.setPenWidth(currentPenWidth)),editor.setPenType(t))}else{var a=$(this).attr("data-action");"crop"===a?(toggleCropMode(!0),editor.cutImage()):"zoom-in"===a?5!=scale_sub&&(scale_sub++,editor.setScale(Number(scales[scale_sub])),$(".zoom-tip").addClass("active").find(".zoom-level").text(100*Number(scales[scale_sub])+"%")):"zoom-out"===a?0!=scale_sub&&(scale_sub--,editor.setScale(Number(scales[scale_sub])),$(".zoom-tip").addClass("active").find(".zoom-level").text(100*Number(scales[scale_sub])+"%")):"insert-image"==a?chrome.cookies.get({url:"https://www.awesomescreenshot.com",name:"screenshot_personal_type"},function(t){return t?"1"!=t.value?(e.preventDefault(),void showPremium("w-aws-advanced","local-image")):void $("#insert-image-input").trigger("click"):(e.preventDefault(),void showPremium("w-aws-advanced-login","local-image"))}):editor[a]()}});for(var d=0,p=imageArr.length,u=[],g=0;g<imageArr.length;g++){var h=new Image;h.src="images/svg/"+imageArr[g]+".svg",u.push({image:h,width:0,height:0,choose_type:TYPE[g]}),h.img_info=u[g],h.onload=function(){d++;var e=this.img_info;e.width=this.naturalWidth,e.height=this.naturalHeight,console.log(e),d<p||t()}}$("#crop-cancel-btn").on("click",function(){toggleCropMode(!1),editor.finishCutImage(!1)}),$("#crop-btn").on("click",function(){toggleCropMode(!1),editor.finishCutImage(!0)}),$("#restore-zoom").on("click",function(e){e.stopPropagation(),editor.setScale(1),$(".zoom-tip").find(".zoom-level").text("100%")}),$(".color-item").on("click",function(){var e=$(this).attr("data-color");$("#tool-current-color").attr("data-color",e),editor.setPenColor(e)}),$(".pen-width-item").on("click",function(){var e=$(this).attr("data-width");$("#tool-current-width").attr("data-width",e).find("span").text(e+"px"),editor.setPenWidth(parseInt(e)),currentPenWidth=parseInt(e)}),$(".font-f-item").on("click",function(){var e=$(this).attr("data-ff");$("#tool-current-font-family").attr("data-ff",e).find("span").text(e),editor.setFontName(e)}),$(".font-s-item").on("click",function(){var e=$(this).attr("data-fs");$("#tool-current-font-size").attr("data-fs",e).text(e+"px"),editor.setFontSize(parseInt(e))}),$(".sub-single-btn").on("click",function(){var e=$(this).attr("data-shape");$(this).parents(".multi-btn").find(".shape-btn").attr("data-shape",e).trigger("click")}),$(".tool-select").find(".current").on("click",function(e){e.stopPropagation(),$(".panel").removeClass("active"),$(this).parent().find(".panel").addClass("active")}),$(".tool-reset-sequence").on("click",function(){editor.resetList()}),$("#image-btn").on("click",function(e){e.stopPropagation();var t=this;chrome.cookies.get({url:"https://www.awesomescreenshot.com",name:"screenshot_personal_type"},function(e){e?"1"==e.value?($(".panel").removeClass("active"),$(t).parent().find(".panel").addClass("active")):showPremium("w-aws-advanced","image"):showPremium("w-aws-advanced-login","image")})}),$(".multi-btn-arrow").on("click",function(e){e.stopPropagation(),$(this).parent().find(".multi-btn-dropdown").addClass("active")}),$(".w-info").find(".primary-btn").on("click",function(){"w-aws-create"!=$(this).parents(".w-info").attr("id")&&$(".w-info").find(".w-close-btn").trigger("click")}),$(".w-info").find(".w-close-btn").on("click",function(){1==$(".w-info").filter(function(){return $(this).is(":visible")}).length&&$("#w-wrapper").css({visibility:"hidden",opacity:0}),$(this).parent().hide(),"w-aws-create"==$(this).parent().attr("id")&&$("#c-p-input").val("")}),$("#save-btn").on("click",function(){save()});var v=["Times New Roman","Arial","Craft Girls","Limelight","Lobster","Anton","Chewy","Frijole","Spirax","Dancing Script","Changa One","Griffy"];WebFontConfig={custom:{families:v,urls:["/stylesheets/font.css"]},loading:function(){console.log("Fonts loading ...")},active:function(){console.log("Fonts active!")},inactive:function(){console.log("error font")}},function(){var e=document.createElement("script");e.src="/javascripts/libs/webfontloader.js",e.type="text/javascript",e.async="true";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()}function showPremium(e,t){$("#w-wrapper").css({visibility:"visible",opacity:1}),$("#"+e).show(),t&&$("#"+e).find(".img-area").empty().append('<img src="images/'+t+'_premium.png"/>')}function prepareEditArea(e){console.log(e);var t=e.menuType,a=e.type,o=e.data;taburl=e.taburl,tabtitle=e.tabtitle,getEditOffset(),window.con=1,window.con2=1,scrollbarWidth=getScrollbarWidth(),$("#save-image").attr({src:o[0]}).load(function(){function i(e,t,a,s,c,d,p,u,g){console.log(e),e||initEditor(showCanvas.toDataURL()),p=v*l,v==w-1&&(a=l-lastH,c=g=lastH),$("#save-image").attr({src:e}).load(function(){$(this).unbind("load"),console.log(this,t,a,s,c,d,p,u,g),showCtx.drawImage(this,t,a,s,c,d,p,u,g),++v>w-1?r():console.log(n),i(o[++n],t,a,s,c,d,p,u,g)})}function s(e,t,a,i,n,r,l,d,p,u){r=j*c,j==f-1&&(t=c-lastW,i=d=lastW),$("#save-image").attr({src:e}).load(function(){$(this).unbind("load"),showCtx.drawImage(this,t,a,i,n,r,l,d,p),j<f-1&&s(o[++j],t,a,i,n,r,l,d,p)})}function r(){++j>f-1||(j==f-1?(d=c-lastW,b=dw=editW-j*c,S=j*c):(d=0,b=dw=c,S=j*c),p=0,y=dh=l,k=0,v=0,n=v+j*w,i(o[n],d,p,b,y,S,k,dw,dh))}var c=this.width,l=this.height,d=e.centerOffX,p=e.centerOffY;switch(a){case"visible":"selected"==t?(editW=e.centerW*window.devicePixelRatio,editH=e.centerH*window.devicePixelRatio,updateEditArea(),updateShowCanvas(),getEditOffset(),addMargin(),getEditOffset()):"upload"==t?(editW=c,editH=l,d=0,p=0,updateEditArea(),updateShowCanvas(),getEditOffset()):"desktop"==t?(editW=c,editH=l,d=0,p=0,updateEditArea(),updateShowCanvas(),getEditOffset()):(console.log(c,l),editW=c-scrollbarWidth,editH=l-scrollbarWidth,d=0,p=0,updateEditArea(),updateShowCanvas(),getEditOffset()),c=editW,l=editH,showCtx.drawImage(this,d*window.devicePixelRatio,p*window.devicePixelRatio,c,l,0,0,c,l),$(this).unbind("load"),initEditor(showCanvas.toDataURL());break;case"entire":var u=e.counter,g=e.ratio,h=e.scrollBar,v=j=n=0,m=o.length,f=u,w=Math.round(m/f);if(!h.x&&h.y){c-=scrollbarWidth,w=m,lastH=l*g.y,"selected"==t?(h.realX&&(l-=scrollbarWidth),editW=e.centerW*window.devicePixelRatio):editW=c,editH=lastH?l*(w-1)+lastH:l*w,updateEditArea(),updateShowCanvas(),getEditOffset(),addMargin(),getEditOffset();var d=0,b=dw=c,S=0,p=0,y=dh=l,k=0;i(o[n],d,p,b,y,S,k,dw,dh)}if(h.x&&!h.y){l-=scrollbarWidth,f=m,lastW=c*g.x,"selected"==t?(h.realY&&(c-=scrollbarWidth),editH=e.centerH*window.devicePixelRatio):editH=l,editW=lastW?c*(f-1)+lastW:c*f,updateEditArea(),updateShowCanvas(),$editArea.addClass("add-margin"),getEditOffset();var d=0,b=dw=c,S=0,p=0,y=dh=l,k=0;s(o[n],d,p,b,y,S,k,dw,dh)}if(h.x&&h.y){lastW=c*g.x,lastH=l*g.y,c-=scrollbarWidth,l-=scrollbarWidth,"selected"==t?(editW=e.centerW*window.devicePixelRatio,editH=e.centerH*window.devicePixelRatio):(editW=lastW?c*(f-1)+lastW:c*f,editH=lastH?l*(w-1)+lastH:l*w),updateEditArea(),updateShowCanvas();var d=0,b=dw=c,S=0,p=0,y=dh=l,k=0;i(o[n],d,p,b,y,S,k,dw,dh)}}})}function prepareTools(){$("#exit").click(function(){chrome.extension.sendRequest({action:"exit"})}),$("#launch-app").unbind().click(function(){if(isAppInstalled){var e=showCanvas.toDataURL();chrome.runtime.sendMessage("mfpiaehgjbbfednooihadalhehabhcjo",{name:"launch",dataUrl:e,title:tabtitle})}else chrome.tabs.create({url:"https://chrome.google.com/webstore/detail/awesome-screenshot-app/mfpiaehgjbbfednooihadalhehabhcjo"})}),$("#tool-panel>div").click(function(e){function t(e){var a=e.nodeName;return"A"!=a&&"DIV"!=a&&t(e=e.parentNode),e}var a=t(e.target);console.log(a),"DIV"!=a.nodeName&&tool(a.id)})}function preparePromote(){$("#promote").click(function(e){$(this).disableSelection(),"A"!=e.target.tagName&&$(this).toggleClass("expanded").find("#content").toggle()})}function bindShortcuts(){var e=!1;$("body").keydown(function(t){var a="";switch(t.which){case 83:a="save";break;case 67:a="crop";break;case 82:a="rectangle";break;case 69:a="ellipse";break;case 65:a="arrow";break;case 76:a="line";break;case 70:a="free-line";break;case 66:a="blur";break;case 84:a="text";break;case 17:e=!0;break;case 90:e&&(a="undo");break;case 16:shift=!0;break;case 13:a="done";break;case 27:a="cancel"}a&&(tool($("body").hasClass("selected")?a:a),"undo"!=a&&(e=!1))}).keyup(function(e){switch(e.which){case 16:shift=!1}})}function tool(e){switch(e){case"save":save();break;case"crop":crop();break;case"color":color();break;case"done":done();break;case"cancel":cancel();break;case"resize":$("#resize select").unbind().change(function(e){resize(this.value)});break;case"undo":undo();break;default:draw(e)}$(".cd-input").off().on("input",function(){var e=$("#cd-width").val(),t=$("#cd-height").val();console.log("sdf"),changeDimension(e,t)}).on("focus",function(){try{dragresize.deselect(!0)}catch(e){console.log(e)}}),$("#cropdiv").on("mousedown",function(){$(".cd-input").trigger("blur")})}function changeDimension(e,t){var a=$("#cropdiv"),o=parseInt(a.css("top")),i=parseInt(a.css("left"));a.css({width:e,height:t}),drawCtx.fillStyle="rgba(80,80,80,0.4)",drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height),drawCtx.fillRect(0,0,drawCanvas.width,drawCanvas.height),drawCtx.clearRect(i,o,e,t)}function i18n(){}function save(){function e(){function e(){localStorage.format&&!isPngCompressed&&(p.image_type=localStorage.format),i=$.ajax({url:u+"cmd="+r+"&pv="+c+"&ct="+l+"&cv="+d,type:"POST",data:JSON.stringify(p),timeout:3e5,dataType:"json",contentType:"text/plain; charset=UTF-8",beforeSend:function(){$("#saveOnline .content").hide("fast"),$("#legacySave").show(),$("#loader").fadeIn("slow")},error:function(e,t,o){a()},success:function(e,o,i){$("#loader").hide(),200==i.status&&1==e.code?(t(e.result.url),isGASafe&&_gaq.push(["_trackEvent","SavePageActions","upload_success","time"])):a()},complete:function(e,t){}})}function t(e){$("#share-button, #email-link").show("slow").click(function(e){var t=e.target;$(t).addClass("visited")}).find("a").each(function(){var t=this;"buzz"==t.id&&(t.href+="message="+encodeURI(tabtitle)+"&url="+encodeURI(taburl)+"&imageurl="+e),"twitter"==t.id?t.href="http://twitter.com/share?url="+encodeURIComponent(e)+"&via=awe_screenshot&text="+tabtitle:$(t).attr({href:t.href+e})}),$("#share-link").show("slow").find('input[type="text"]').attr({value:e}).bind("mouseup",function(){$(this).select()})}function a(){$("#loader").hide("fast"),s||$("#error").show().find("#retry").unbind("click").click(function(){$("#error").hide(),$("#loader").show().find("a").unbind("click").click(o),e()})}function o(){s=1,i.abort(),$("#upload").parent().siblings().hide("fast").end().fadeIn("slow"),s=0}var i,n=$("#save-image").attr("src").replace(/^data:image\/(png|jpeg);base64,/,""),s=0,r="imageUpload",c="1.0",l="chrome",d=getLocVersion(),p={src_url:taburl,src_title:tabtitle,image_md5:$.md5(n),image_type:"jpg",image_content:n},u="https://awesomescreenshot.com/client?";e(),window.showShare=t,window.errorHandle=a,window.abortUpload=o}if(window.location.href.match(/gmail=(.*)/)){var t=parseInt(window.location.href.match(/gmail=(.*)/)[1]),a=editor.getImageDataURL();return chrome.tabs.sendRequest(t,{action:"insertImage",dataURL:a}),void setTimeout(function(){window.close()},0)}$(".content>.as, .content>.as").removeAttr("style"),$("#saveOnline .content .diigo input[name=title]").val(tabtitle),document.body.scrollTop=0,$("#save-tip").hide(),$("#image_loader").css({display:"inline-block"}),$("#save-image, #re-edit").css({visibility:"hidden"}),$("body").removeClass("crop draw-text").addClass("save"),$("#save").removeClass("active"),$("#editor-outer-container").hide(),$("#draw-canvas").attr({width:0,height:0}),$("#share+dd").html(chrome.i18n.getMessage("savedShareDesc")),$("#upload").parent().html($("#upload")[0].outerHTML),$($editArea).enableSelection(),$("#upload").unbind().click(e),$("#banner").show(),$("#launch-app").hide(),$("#re-edit").unbind().text(chrome.i18n.getMessage("reEdit")).click(function(){1!=uploadFlag?($("#saveOnline .content .diigo input[name=title]").val(""),$("body").removeClass("save"),$("#banner").hide(),$("#editor-outer-container").show(),$($editArea).disableSelection(),$("#share+dd div").hide(),$("#save_local+dd>p").hide(),$("#launch-app").show(),$("#gdrive-share-link").hide(),$(".sgdrive .saveForm").show()):$("#uploadingWarning").jqm().jqmShow()});a="";setTimeout(function(){function e(){$("#image_loader").hide(),$("#save-image, #re-edit").css({visibility:"visible"}),$("#save-image").outerWidth()>parseInt($("#save_image_wrapper").css("width"))&&$("#save-image").css({width:"100%"}),$("#save-tip").show()}!function(t){$("#save-image")[0].src!=t?$("#save-image").attr({src:t}).load(function(){$(this).css({width:"auto"}),this.width>=parseInt($("#save_image_wrapper").css("width"))&&$(this).css({width:"100%"}),e(),$(this).unbind();try{var t=colorThief.getColor($("#save-image")[0]);mainColor="rgb("+t.join(",")+")"}catch(e){}}):e()}(a="jpg"==localStorage.format?editor.getImageDataURL("image/jpeg"):editor.getImageDataURL());$("#save-image").attr("src").split(",")[1].replace(/\+/g,"%2b"),tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," "),$("#save-image").attr("src").split(",")[0].split("/")[1].split(";")[0];$("#save-flash-btn").on("click",function(){SavePage.saveLocal()}),chrome.extension.sendRequest({action:"return_image_data",data:a.replace(/^data:image\/(png|jpeg);base64,/,""),title:tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," ")})},100),window.uploadImageToAS=e,isSavePageInit||(SavePage.init(),isSavePageInit=!0)}function updateEditArea(){$editArea.css({width:editW+"px",height:editH+"px"})}function updateShowCanvas(){$(showCanvas).attr({width:editW,height:editH})}function updateBtnBg(e){"undo"!=e&&"color"!=e&&"cancel"!=e&&"done"!=e&&$($("#"+e)).siblings().removeClass("active").end().addClass("active")}function getInitDim(){editW=$(window).width(),editH=$(window).height()}function getEditOffset(){var e=$editArea.offset();offsetX=e.left,offsetY=e.top}function getScrollbarWidth(){var e=document.createElement("p");e.style.width="100%",e.style.height="200px";var t=document.createElement("div");t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.visibility="hidden",t.style.width="200px",t.style.height="150px",t.style.overflow="hidden",t.appendChild(e),document.body.appendChild(t);var a=e.offsetWidth;t.style.overflow="scroll";var o=e.offsetWidth;return a==o&&(o=t.clientWidth),document.body.removeChild(t),a-o}function getLocVersion(){var e=new XMLHttpRequest;return e.open("GET","./manifest.json",!1),e.send(null),JSON.parse(e.responseText).version}function addMargin(){offsetX||48!=offsetY&&88!=offsetY?$editArea.addClass("add-margin"):$editArea.removeClass("add-margin")}function isCrOS(){return-1!=navigator.appVersion.indexOf("CrOS")}function showInfo(e){if(e)t='<div class="w-info" id="w-cpy-info"><div class="w-info-topBar"><div class="w-info-logo"></div><div>Awesome Screenshot</div></div><p>It has been announced that Chrome will no longer allow extensions to make use of NPAPI, and therefore extensions will no longer be able to provide "copy image to clipboard" feature.   The current "Copy" feature is a workaround. If It doesn\'t work for you, please follow the instruction below:</p><p>Right-click the image in the left pane, and then select "<b>Copy Image</b>". </p><div class="w-close-btn"></div></div>';else var t='<div class="w-info" id="w-cpy-info"><div class="w-info-topBar"><div class="w-info-logo"></div><div>Awesome Screenshot</div></div><p>Previously, Awesome screenshot  was able to make use of plugins through a standard plugin system called NPAPI. It has been <a href="http://blog.chromium.org/2013/09/saying-goodbye-to-our-old-friend-npapi.html" target="_blank">announced</a> that Chrome will no longer allow extensions to make use of NPAPI, and therefore extensions will no longer be able to provide "copy image to clipboard" feature. </p><p>After some hard work, we finally worked around this issue and enable the copy feature for you again. </p><p>We are sorry for this change.  If you like awesome screenshot, please <a href="https://chrome.google.com/webstore/detail/awesome-screenshot-captur/alelhddbbhepgpmgidjdcjakblofbmce/reviews">give it a nice 5-star rating</a>. Thanks for the support!</p><div class="w-close-btn"></div></div>';var a=$('<div class="w-wrapper"></div>').appendTo(document.body).css({visibility:"visible",opacity:1}),o=$(t).appendTo(document.body).show();o.find(".w-close-btn").on("click",function(){a.remove(),o.remove()})}var showCanvas,isPngCompressed=!1,isSavePageInit=!1,Bg=chrome.extension.getBackgroundPage(),offsetX,offsetY,editW,editH,scrollbarWidth=17,$editArea,actions=[],initFlag=1,requestFlag=1,textFlag=1,uploadFlag=!1,showCanvas,showCtx,drawCanvas,drawCtx,drawColor="red",currentPenWidth=4,highlightColor="rgba(255,0,0,.3)",highlightWidth=16,taburl,tabtitle,compressRatio=80,resizeFactor=100,shift=!1,isGASafe="Windows"==BrowserDetect.OS||"Linux"==BrowserDetect.OS,imageArr=["smile","cry","tick-off","cross","forbidden","warning","q-mark","like","heart","star","chicken","dog","rain","sun","cloud","thunder","fish","fish2","tree1","tree2","building1","building2","package","tent","umbrella","car","basketball","beer"],TYPE=["part","part","part","full","full","full","full","part","part","part","part","part","part","part","part","part","part","part","part","part","part","part","part","part","part","part","part","part"],gDriveConfig={client_id:"934696770472-j7vpq5hjkgke5599r0jacuh95ekhga85.apps.googleusercontent.com",client_secret:"wrVV86YTdcrqYtct2BRapBpm",api_scope:"https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email"};/gmail=(.*)/.test(window.location.href)&&$("#save-btn").text("Done and insert to gmail");var server_url="https://www.awesomescreenshot.com",isAppInstalled=!1,colorThief=new ColorThief,mainColor="rgb(255,255,255)",editor=null,scales=["0.25","0.5","0.75","1","1.5","2"],scale_sub=3;chrome.runtime.sendMessage("mfpiaehgjbbfednooihadalhehabhcjo",{name:"handshake"},function(e){e&&(isAppInstalled=!0)});var dragresize,googleAuth=new OAuth2("google",gDriveConfig);window.addEventListener("message",function(e){"adjustPromotionSize"==e.data.action?$("#promotion-frame").css({height:e.data.height}):"removeBanner"==e.data.action&&$("#promotion-container-bottom").hide()}),window.addEventListener("resize",function(){getEditOffset()});var cflag=0;$(document).ready(function(){$editArea=$("#edit-area").disableSelection(),showCanvas=document.getElementById("show-canvas"),showCtx=showCanvas.getContext("2d"),chrome.extension.onRequest.addListener(function(e,t,a){console.log(requestFlag,e),requestFlag&&e.menuType&&(i18n(),prepareEditArea(e),prepareTools(),preparePromote(),requestFlag=0),"awsLoginByGoogle"===e.name&&SavePage.getAwsPojects()}),chrome.extension.sendRequest({action:"ready"}),$(window).unbind("resize").resize(function(){getEditOffset(),addMargin()}),ADs.cpn()});var ADs={SearchO:function(){var e="";e+='<div id="promotions" style="display:none">',e+='<span id="closeAdsMsg"></span>',e+='<h4 class="promoHeader">More from Diigo</h4>',e+='<div id="appSearchO" class="msgItem">',e+='<a target="_blank" href="https://chrome.google.com/webstore/detail/eekjldapjblgadclklmgolijbagmdnfk">The easiest way to access different search engines.>></a>',e+="</div></div>",$("#promotion-container").append(e),$("head").append('<link rel="stylesheet" href="stylesheets/ads.css" />'),$("#closeAdsMsg").click(function(e){console.log($('link[href="css/ads.css"]')),$('link[href="stylesheets/ads.css"]').remove()})},cpn:function(){$("#promotion-container").append('<iframe src="http://www.awesomescreenshot.com/promotion.html"></iframe>'),$("head").append('<link rel="stylesheet" href="stylesheets/ads_cpn.css" />')}},Account={};Account.initForm=function(){var e='<div id="account" class="jqmWindow"><table><tr><td><div class="loginByGoogle"><strong>New to Diigo? Connect to diigo.com via</strong><a href="'+("https://www.diigo.com/account/thirdparty/openid?openid_url=https://www.google.com/accounts/o8/id&redirect_url="+encodeURIComponent(chrome.extension.getURL(""))+"&request_from=awesome_screenshot")+'" class="button" target="_blank">Google account</a></div></td></tr></table></div>';$(e).appendTo($("#saveOnline .content")).hide()};var SavePage={};SavePage.getImageSrc=function(){return $("#save-image").attr("src").replace(/^data:image\/(png|jpeg);base64,/,"")},SavePage.response=function(e,t){switch(e.status){case 200:1==JSON.parse(e.response).code&&t(e);break;case 401:-1==JSON.parse(e.response).code&&$("#authError").jqm().jqmShow();break;default:$("#networkError").jqm().jqmShow()}$("#account").removeClass("authing")},SavePage.responsea=function(e,t){switch(e.status){case 200:1==JSON.parse(e.response).code&&t(e);break;case 401:-1==JSON.parse(e.response).code&&SavePage.signout();break;default:console.log("error")}$("#account").removeClass("authing")},SavePage.request=function(e,t,a){var o="",i={},n={v:1,pv:1,cv:3,ct:"chrome_awesome_screenshot",url:"https://www.diigo.com/kree"};switch(e){case"signin":n.url="https://secure.diigo.com/kree";break;case"uploadItems":o="&image="+encodeURIComponent(SavePage.getImageSrc())}t=JSON.stringify(t),o="cv="+n.cv+"&ct="+n.ct+"&v="+n.v+"&cmd="+e+"&json="+encodeURIComponent(t)+"&s="+hex_md5(""+n.ct+n.cv+t+n.v+e)+o,(i=new XMLHttpRequest).open("POST",n.url+"/pv="+n.pv+"/ct="+n.ct,!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.setRequestHeader("X-Same-Domain","true"),i.onreadystatechange=function(){4==this.readyState&&(SavePage.response(i,a),i=null)},i.send(o)},SavePage.requesta=function(e,t,a){var o="",i={},n={v:1,pv:1,cv:3,ct:"chrome_awesome_screenshot",url:"https://www.diigo.com/kree"};switch(e){case"signin":n.url="https://secure.diigo.com/kree";break;case"uploadItems":o="&image="+encodeURIComponent(SavePage.getImageSrc())}t=JSON.stringify(t),o="cv="+n.cv+"&ct="+n.ct+"&v="+n.v+"&cmd="+e+"&json="+encodeURIComponent(t)+"&s="+hex_md5(""+n.ct+n.cv+t+n.v+e)+o,(i=new XMLHttpRequest).open("POST",n.url+"/pv="+n.pv+"/ct="+n.ct,!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.setRequestHeader("X-Same-Domain","true"),i.onreadystatechange=function(){4==this.readyState&&(SavePage.responsea(i,a),i=null)},i.send(o)},SavePage.updateUserInfo=function(){if(localStorage.user_info){var e=JSON.parse(localStorage.user_info).info.username;$("#accountInfo .name").attr("href","https://www.diigo.com/user/"+e+"?type=image").html(e),$("#saveOptionContent>.diigo").addClass("signin");var t=JSON.parse(localStorage.user_info).permission;t.is_premium||t.image?($(".diigo .saveForm").show(),$(".premium").hide()):($(".diigo .saveForm").hide(),$(".premium").show())}else $("#saveOptionContent>.diigo").removeClass("signin"),$(".share, .saveForm, .premium",$(".diigo")).hide()},SavePage.resetAws=function(){$(".aws-form-area").show(),$(".a-upload-area").hide(),$(".a-login-tip").hide(),$("#a-username").val(""),$("#a-password").val("")},SavePage.handleUserInfo=function(e){localStorage.user_info=JSON.stringify(JSON.parse(e.response).result),SavePage.updateUserInfo()},SavePage.loadUserInfo=function(e,t){SavePage.requesta("loadUserInfo",{user_id:e},function(e){t?t(e):SavePage.handleUserInfo(e)})},SavePage.signout=function(){var e=document.createElement("script");e.setAttribute("src","https://www.diigo.com/sign-out"),document.body.appendChild(e),localStorage.user_info="",SavePage.updateUserInfo()},SavePage.AwsSignout=function(){$.get(server_url+"/user/loginOut"),SavePage.resetAws()},SavePage.loginByGoogle=function(){chrome.extension.onRequest.addListener(function(e,t,a){switch(e.name){case"loginByGoogle":SavePage.request("syncItems",{folder_server_id_1:[]},function(e){chrome.extension.onRequest.removeListener(),SavePage.loadUserInfo(JSON.parse(e.response).user_id)})}})},SavePage.loginToAws=function(){var e=$('.aws input[name="a-username"]').val(),t=$('.aws input[name="a-password"]').val();(function(){var a=!1;return e&&t?a=!0:e&&!t?$(".aws input[name=a-password]").focus().addClass("empty"):!e&&t?$(".aws input[name=a-username]").focus().addClass("empty"):($(".aws input[name=a-username]").focus().addClass("empty"),$(".aws input[name=a-password]").addClass("empty")),a})()&&($(".a-login-tip").show(),$.ajax({type:"POST",dataType:"json",cache:!1,url:server_url+"/user/loginCommit?from=chrome_extension",data:{mail:e,password:t},success:function(e){0==e.ErrorCode?(e.S&&(localStorage.aws_s=e.S,localStorage.aws_username=e.Fullname,localStorage.aws_uid=e.Uid),SavePage.getAwsPojects()):alert(e.ErrorMsg),$(".a-login-tip").hide()},error:function(e){alert("error:"+e.responseText),$(".a-login-tip").hide()}}))},SavePage.getAwsPojects=function(){$.ajax({type:"GET",dataType:"json",cache:!1,url:server_url+"/getProjectListFromExtension",success:function(e){console.log(e),SavePage.updateAwsProject(e),localStorage.aws_project=JSON.stringify(e)},error:function(e){alert("error:"+e.responseText)}})},SavePage.updateAwsUserInfo=function(e){$(".a-d-user").text(e),$(".aws-form-area").hide(),$(".a-upload-area").show()},SavePage.updateAwsProject=function(e){var t=e.ProjectInfo;if(t.length>0){$("#a-project").empty();for(var a=0;a<t.length;a++)$('<option value="'+t[a].ProjectId+'">'+t[a].Name+"</option>").appendTo($("#a-project"));$('<option value="-1">---------------------</option>').appendTo($("#a-project")),$('<option value="-2">Create new projects</option>').appendTo($("#a-project")),$('<option value="-3">Refresh projects</option>').appendTo($("#a-project"))}$(".a-d-user").text(e.User.Fullname),$(".aws-form-area").hide(),$(".a-upload-area").show()},SavePage.loginByDiigo=function(){var e=$('#account .loginByDiigo input[name="username"]').val(),t=$('#account .loginByDiigo input[name="password"]').val();(function(){var a=!1;return e&&t?a=!0:e&&!t?$("#account input[name=password]").focus().addClass("empty"):!e&&t?$("#account input[name=username]").focus().addClass("empty"):($("#account input[name=username]").focus().addClass("empty"),$("#account input[name=password]").addClass("empty")),a})()&&($("#account").addClass("authing"),SavePage.request("signin",{user:e,password:t},function(e){SavePage.handleUserInfo(e)}))},SavePage.initAccount=function(){function e(e){var t=$("#sign-up-tip"),a=$("#sign-in-tip"),o=$("#a-login-area"),i=$("#a-register-area");switch(e){case"sign-up":t.hide(),a.show(),o.hide(),i.show();break;case"sign-in":t.show(),a.hide(),o.show(),i.hide()}}localStorage.user_info?SavePage.loadUserInfo(JSON.parse(localStorage.user_info).info.user_id):SavePage.updateUserInfo(),chrome.cookies.get({url:"https://www.awesomescreenshot.com",name:"screenshot_personal_fullname"},function(e){if(e){var t=decodeURI(e.value);SavePage.updateAwsUserInfo(t),SavePage.getAwsPojects()}}),$(".loginByGoogle .button").click(SavePage.loginByGoogle),$(".aws .a-login").click(SavePage.loginToAws),$(".aws .a-sign-out").click(function(e){e.preventDefault(),SavePage.AwsSignout()}),$(".aws .g-a-login").on("click",function(){chrome.tabs.create({url:server_url+"/openid/auth2?redirect_url="+encodeURIComponent(chrome.extension.getURL("aws"))})}),$(".loginByDiigo .button").click(SavePage.loginByDiigo),$("body").keyup(function(e){$(e.target).hasParent(".loginByDiigo")&&13===e.keyCode&&SavePage.loginByDiigo()}),$("#open-sign-up").on("click",function(e){e.preventDefault(),window.open(server_url+"/user/login")}),$("#open-sign-in").on("click",function(t){t.preventDefault(),e("sign-in")})},SavePage.uploadImageToAws=function(){var e=$(".aws input[name=a-title]").val(),t=$("#a-project").val();localStorage.aws_s,localStorage.aws_uid;$(".aws .a-upload-area").hide().after($('<div class="loader">Uploading</div>')),$.ajax({type:"POST",dataType:"json",cache:!1,url:server_url+"/extensionUpload",data:{name:e,image:$("#save-image")[0].src,bgColor:mainColor,project_id:t},success:function(e){e&&(0===e.ErrorCode?SavePage.showUploadResponse("aws",{url:server_url+"/image/"+e.ImgId+"/"+e.Token,_url:server_url+"/showImage?img_id="+e.ImgId}):1003===e.ErrorCode&&"MaximumMumberLimitReached!"===e.ErrorMsg&&($("#awsWarning").jqm().jqmShow(),$(".aws .a-upload-area").show(),$(".loader").remove()))},error:function(e){alert("error:"+e.responseText)}})},SavePage.showCreateWin=function(){$("#w-wrapper").css({visibility:"visible",opacity:1}),$("#w-aws-create").show()},SavePage.showUploadResponse=function(e,t){function a(){$(".socialButton, .emailButton",$("."+e)).click(function(e){$(e.target).addClass("visited")}).find("a").each(function(){var e=this;$(e).hasClass("weibo")?e.href+="&url="+encodeURIComponent(o)+"&appkey=4237332164&title=&pic=&ralateUid=":$(e).hasClass("twitter")?e.href="http://twitter.com/share?url="+encodeURIComponent(o)+"&via=awe_screenshot&text="+tabtitle:$(e).attr({href:e.href+o})}),$(".shareLink",$("."+e)).find("input[type=text]").val(o).bind("mouseup",function(){$(this).select()})}console.log(e,t),$(".loader").remove();var o="";"diigo"===e?$("#privacy").is(":checked")?(o=t.url,$(".diigo .privateLink").attr({href:o}),$(".share",$("."+e)).removeClass("public").addClass("private")):(o=t.image_share_url,a(),$(".share",$("."+e)).removeClass("private").addClass("public")):(o=t.url,a()),$(".share",$("."+e)).show(400),"aws"===e&&($(".share",$("."+e)).append('<a href="'+t._url+'" target="_blank">Go to image on AwesomeScreenshot</a>'),$(".share",$("."+e)).find(".shareLink p").text("Image link (Share the image to gather point-specific feedback!)"))},SavePage.uploadImageToAS=function(){$(".as .saveForm").hide("fast").after($('<div class="loader">Uploading</div>'));var e="",t={},a={pv:"1.0",cv:getLocVersion(),ct:"chrome",cmd:"imageUpload",url:"https://awesomescreenshot.com/client?"},o=SavePage.getImageSrc();e=JSON.stringify({src_url:taburl,src_title:tabtitle,image_md5:hex_md5(o),image_type:"png",image_content:o}),(t=new XMLHttpRequest).open("POST",a.url+"cmd="+a.cmd+"&pv="+a.pv+"&ct="+a.ct+"&cv="+a.cv,!0),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.setRequestHeader("X-Same-Domain","true"),t.onreadystatechange=function(){4==this.readyState&&(SavePage.response(t,function(e){SavePage.showUploadResponse("as",JSON.parse(e.response).result)}),t=null)},t.send(e)},SavePage.showUpgradeWin=function(){$("#w-wrapper").css({visibility:"visible",opacity:1}),$("#w-aws-upgrade").show()},SavePage.uploadImageToDiigo=function(){$(".diigo .saveForm").hide("fast").after($('<div class="loader">Uploading</div>'));var e={items:[{local_id:"image",server_id:-1,cmd:1,type:2,local_file_md5:hex_md5(SavePage.getImageSrc()),tags:$(".diigo input[name=tags]").val(),mode:$("#privacy").is(":checked")?2:0,title:$(".diigo input[name=title]").val()||tabtitle,src_url:/http:|https:|ftp:/.test(taburl)?taburl:"",src_title:tabtitle}]};SavePage.loadUserInfo(JSON.parse(localStorage.user_info).info.user_id,function(t){var a=JSON.parse(t.response).result,o=a.permission;localStorage.user_info=JSON.stringify(a),(o.is_premium||o.image)&&SavePage.request("uploadItems",e,function(e){SavePage.showUploadResponse("diigo",JSON.parse(e.response).result.items[0])})})},SavePage.setPublicGdrive=function(e){googleAuth.authorize(function(){var t=new XMLHttpRequest;t.open("POST","https://www.googleapis.com/drive/v2/files/"+e+"/permissions"),t.setRequestHeader("Authorization","OAuth "+googleAuth.getAccessToken()),t.setRequestHeader("Content-Type","application/json");var a={role:"reader",type:"anyone"},o=JSON.stringify(a);t.onreadystatechange=function(){this.readyState},t.send(o)})},SavePage.saveToGdrive=function(){var e=SavePage.getImageSrc(),t=$("#gdriveImageName").val();googleAuth.authorize(function(){var a=new XMLHttpRequest;a.open("POST","https://www.googleapis.com/upload/drive/v2/files?uploadType=multipart"),a.setRequestHeader("Authorization","OAuth "+googleAuth.getAccessToken()),a.setRequestHeader("Content-Type",'multipart/mixed; boundary="--287032381131322"'),a.onreadystatechange=function(){if(4==this.readyState){switch(uploadFlag=!1,a.status){case 200:var e=JSON.parse(a.response);e.alternateLink&&e.ownerNames&&(0==$("#gdrive-private").prop("checked")?SavePage.setPublicGdrive(e.id):$("#gdrive-share-link p").text("Image Link (Private, only you can view it.)"),$("#gdrive-user").show(),$(".loader").remove(),$("#gdrive-share-link input").val(e.alternateLink),$("#sccess-tip").show().delay(1e3).fadeOut(),$("#gdrive-share-link").show());break;case 401:$("#GauthError").jqm().jqmShow(),$(".loader").remove(),$(".sgdrive .saveForm").show();break;default:$("#networkError").jqm().jqmShow(),$(".loader").remove(),$(".sgdrive .saveForm").show()}a=null}};var o={title:t+".png",mimeType:"image/png",description:"Uploaded by Awesome Screenshot Extension"},i="\r\n----287032381131322\r\nContent-Type: application/json\r\n\r\n"+JSON.stringify(o)+"\r\n----287032381131322\r\nContent-Type: image/png\r\nContent-Transfer-Encoding: base64\r\n\r\n"+e+"\r\n----287032381131322--";a.send(i),uploadFlag=!0;var n=new XMLHttpRequest;n.open("GET","https://www.googleapis.com/oauth2/v2/userinfo"),n.setRequestHeader("Authorization","OAuth "+googleAuth.getAccessToken()),n.onreadystatechange=function(){if(4==this.readyState){var e=JSON.parse(n.response);localStorage.gdrive_current_user=e.email,$("#saveOptionList li.sgdrive span").text("("+e.email+")"),$("#gdrive-user p span").text(e.email)}},n.send(),$(".sgdrive .saveForm").hide("fast").after($('<div class="loader">Uploading</div>'))})},SavePage.saveLocal=function(){function e(e,t,a){t=t||"",a=a||1024;for(var o=atob(e),i=[],n=0;n<o.length;n+=a){var s=o.slice(n,n+a),r=Array.prototype.map.call(s,function(e){return e.charCodeAt(0)}),c=new Uint8Array(r);i.push(c)}return new Blob(i,{type:t})}try{chrome.permissions.request({permissions:["downloads"]},function(e){if(e){var t=document.getElementById("save-image").src,a=t.split(",")[0].split(":")[1].split(";")[0].split("/")[1];"jpeg"==a&&(a="jpg");var o=(tabtitle=tabtitle.replace(/(\.|\:)/g," ")).replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," ")+"."+a,i={url:t,filename:o=o.trim(),saveAs:!0};chrome.downloads.download(i)}})}catch(c){console.log(c);var t=document.getElementById("save-image").src,a=t.split(",")[1],o=t.split(",")[0].split(":")[1].split(";")[0],i=e(a,o),n=(window.webkitURL||window.URL).createObjectURL(i),s=document.createElement("a"),r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.setAttribute("href",n),s.setAttribute("download",tabtitle.replace(/[#$~!@%^&*();'"?><\[\]{}\|,:\/=+-]/g," ")+"."+o.split("/")[1]),s.dispatchEvent(r)}},SavePage.copy=function(){try{var e=$('<div contenteditable="true"></div>').css({height:"500px",width:"500px",position:"absolute"}).appendTo(document.body).append($("#save-image").clone()).append("test").focus(),t=document.createRange();console.log(e.find("#save-image")[0]),t.selectNode(e[0]);var a=window.getSelection();a.removeAllRanges(),a.addRange(t),document.execCommand("Copy",!1,null),e.remove(),$(".copy_success").show(0).delay(3e3).fadeOut("slow")}catch(e){console.log(e),$(".copy_unsupport").show(0).delay(3e3).fadeOut("slow")}},SavePage.print=function(){var e=$("#print_area").html(),t=document.createElement("IFRAME");$(t).attr({style:"position:absolute;width:0px;height:0px;left:-500px;top:-500px;",id:"print"}),document.body.appendChild(t);var a='<div style="margin:0 auto;text-align:center">'+e+"</div>";t.contentWindow.document.write(a);var o=t.contentWindow;o.close(),o.focus(),o.print(),$("iframe#print").remove()},SavePage.initSaveOption=function(){var e='<div class="share"></div>',t='<div class="socialButton"><a class="twitter" href="http://twitter.com/home?status=" target="_blank"><span></span>Twitter</a><a class="facebook" href="http://www.facebook.com/sharer.php?u=" target="_blank"><span></span>Facebook</a><a class="weibo" href="http://service.weibo.com/share/share.php?" target="_blank"><span></span>Weibo</a></div>',a='<div class="emailButton"><a class="gmail" href="https://mail.google.com/mail/?view=cm&amp;tf=0&amp;fs=1&amp;body=" target="_blank"><span></span>Gmail</a><a class="yahoo" href="http://compose.mail.yahoo.com/" target="_blank"><span></span>Yahoo mail</a><a class="hotmail" href="http://www.hotmail.msn.com/secure/start?action=compose&amp;body=" target="_blank"><span></span>Hotmail</a></div>',o='<div class="shareLink"><p>Image Link (share via MSN, GTalk, etc.)</p><input type="text" /></div>';$(e).html(t+a+o+'<a href="" class="privateLink" target="_blank">See screenshot on diigo.com</a>').prependTo($("#saveOptionContent .diigo")).hide(),$(e).html(t+a+o).prependTo($("#saveOptionContent .as")).hide(),$(e).html(t+a+o).prependTo($("#save-aws .aws")).hide(),$(".diigo .saveForm input[name=title]").val(tabtitle),$(".aws .a-upload-area input[name=a-title]").val(tabtitle),$(".sgdrive #gdriveImageName").val(tabtitle),$("#gdrive-user p span").bind("click",function(){$("#notice").show()}),localStorage.gdrive_current_user&&($("#gdrive-save").text("Save"),$("#gdrive-user").show(),$("#gdrive-user p span").text(localStorage.gdrive_current_user),$("#saveOptionList li.sgdrive span").text("("+localStorage.gdrive_current_user+")")),$(".diigo .saveForm input[name=tags]").val(chrome.extension.getBackgroundPage().recommendedTags),$("#saveOptionHead .back").click(function(e){setTimeout(function(){$("#saveOptionContent>li.selected").removeClass("selected")},200),$("#saveOptionHead, #saveOptionBody").removeClass("showContent"),$("#saveLocal").show(),$("#about-diigo").hide()}),$("#saveLocal").click(function(e){var t=e.target;$(t).hasClass("button")&&($(t).hasParent(".save_button")?SavePage.saveLocal():$(t).hasParent(".copy_button")?SavePage.copy():$(t).hasParent(".print_button")&&SavePage.print())}),$(".l-s-btn").on("click",function(){$(this).hasClass("copy")?SavePage.copy():$(this).hasClass("print")&&SavePage.print()}),$(".signout").click(function(e){SavePage.signout()}),$(".btnDark").click(function(e){$(e.target).hasParent("#authError")?$("#saveOptionContent>.diigo").removeClass("signin"):"clear-authentication"==e.target.id&&($(".loader").remove(),$(".sgdrive .saveForm").show(),$("#gdrive-save").text("Connect and Save"),$("#notice").hide(),$("#gdrive-user").hide(),$("#saveOptionList li.sgdrive span").text(""),googleAuth.clear(),delete localStorage.gdrive_current_user,googleAuth=new OAuth2("google",gDriveConfig))}),$("#saveOptionList").click(function(e){var t=e.target;$(t).hasParent("#saveOptionList")&&!$(t).hasClass("more-option")&&($("#saveOptionContent").find("."+t.className).addClass("selected"),$("#saveOptionHead, #saveOptionBody").addClass("showContent"),$("#saveLocal").hide(),$(t).hasClass("diigo")&&$("#about-diigo").show())}),$(".sgdrive span").click(function(){$("#saveOptionContent").find(".sgdrive").addClass("selected"),$("#saveOptionHead, #saveOptionBody").addClass("showContent"),$("#saveLocal").hide()}),$("#gdrive-signout").click(function(e){var t=e.target;$(t).hasClass("jqmClose")&&($(".loader").remove(),$(".sgdrive .saveForm").show()),$("#gdrive-save").text("Connect and Save"),$("#notice").hide(),$("#gdrive-user").hide(),$("#saveOptionList li.sgdrive span").text(""),googleAuth.clear(),delete localStorage.gdrive_current_user,googleAuth=new OAuth2("google",gDriveConfig)}),$("#saveOptionContent").click(function(e){$(e.target).hasClass("save")&&($(e.target).hasParent(".diigo")?SavePage.uploadImageToDiigo():$(e.target).hasParent(".as")?SavePage.uploadImageToAS():"gdrive-save"==e.target.id?SavePage.saveToGdrive():"gdrive-connect"==e.target.id?SavePage.authorizeGdrive():$(e.target).hasParent(".local")&&SavePage.saveLocal())}),$("#a-upload-btn").on("click",function(){SavePage.uploadImageToAws()})},SavePage.getAwsUserInfo=function(){$.ajax({url:server_url+"/user/getUserInfoFromExtension",type:"GET",cache:!1,success:function(e){0==e.ErrorCode?(e.S,SavePage.getAwsPojects()):alert(e.ErrorMsg),$(".a-login-tip").hide()},error:function(e){alert("error:"+e.responseText),$(".a-login-tip").hide()}})},SavePage.addNewProject=function(e){$('<option value="'+e.ProjectId+'">'+e.Name+"</option>").prependTo($("#a-project")),$("#a-project").val(e.ProjectId)},SavePage.init=function(){SavePage.initSaveOption(),SavePage.initAccount(),$("#open-path").click(function(){SavePage.openSavePath()}),$("#w-cpy").on("click",function(e){e.preventDefault(),showInfo()}),$("#c-tip").on("click",function(e){e.preventDefault(),showInfo(!0)}),$("#test-promo").on("click",function(e){e.preventDefault(),$("#w-wrapper").css({visibility:"visible",opacity:1}),$("#w-aws-info").show()}),$(".noti").on("click",function(e){e.preventDefault(),$(this).hide(),localStorage["show-noti"]="false",$("#w-wrapper").css({visibility:"visible",opacity:1}),$("#w-aws-info").show()}),$("#more-option").on("click",function(e){e.preventDefault(),$(this).hide(),$("#save-cloud").show()}),"true"===localStorage["show-noti"]&&$(".noti").show(),$("#a-project").on("change",function(){var e=$(this),t=e.val();switch(console.log(t),t){case"-1":break;case"-2":e.val(-1),SavePage.showCreateWin();break;case"-3":e.val(-1),SavePage.getAwsPojects()}}),$("#c-p-btn").on("click",function(e){e.preventDefault();var t=$(this),a=$("#c-p-input").val();""!=a.trim()?($(this).text("Creating...").addClass("disabled"),$.ajax({type:"POST",dataType:"json",cache:!1,url:server_url+"/createProject?from=chrome_extension",data:{name:a},success:function(e){0==e.ErrorCode?(SavePage.addNewProject(e.ProjectDetail),$("#w-aws-create").find(".w-close-btn").trigger("click")):1007==e.ErrorCode&&"The maximum number of limit is reached!"==e.ErrorMsg&&SavePage.showUpgradeWin(),t.text("Create").removeClass("disabled")},error:function(e){alert("error:"+e.responseText),t.text("Create").removeClass("disabled")}})):$("#c-p-input").focus()}),Bg.getPremium().then(function(e){e||$("#upgrade-promotion").show()})},chrome.extension.sendRequest({action:"closeWin"});